@startuml
skinparam classAttributeIconSize 0
skinparam componentStyle rectangle
title YerbEngine - Detailed Class Diagram

' Core
package "Core" {
  class GameEngine {
    - m_scenes: map<string, shared_ptr<Scene>>
    - m_currentSceneName: string
    - m_isRunning: bool
    - m_fontManager: unique_ptr<FontManager>
    - m_audioManager: unique_ptr<AudioManager>
    - m_textureManager: unique_ptr<TextureManager>
    - m_audioSampleBuffer: unique_ptr<AudioSampleBuffer>
    - m_videoManager: unique_ptr<VideoManager>
    - m_configStore: unique_ptr<ConfigStore>
    - m_configAdapter: unique_ptr<ConfigAdapter>
    - m_namedStores: map<string, unique_ptr<ConfigStore>>
    - m_namedAdapters: map<string, unique_ptr<ConfigAdapter>>
    - Update() : void
    - S_UserInput() : void
    - {static} MainLoop(arg: void*) : void
    - {static} CleanUp() : void
    + GameEngine(assetsDir: Path, configDir: Path)
    + ~GameEngine()
    + IsRunning() : bool
    + LoadScene(sceneName: string, scene: shared_ptr<Scene>) : void
    + AddConfig(name: string, store: unique_ptr<ConfigStore>) : void
    + GetConfig() : ConfigAdapter&
    + GetConfig(name: string) : ConfigAdapter&
    + GetConfigStore() : ConfigStore&
    + GetConfigStore(name: string) : ConfigStore&
    + getFontManager() : FontManager&
    + getAudioManager() : AudioManager&
    + getAudioSampleBuffer() : AudioSampleBuffer&
    + getVideoManager() : VideoManager&
    + getTextureManager() : TextureManager&
    + run() : void
    + quit() : void
  }

  abstract class Scene {
    - m_gameEngine: GameEngine*
    - m_lastFrameTime: Uint64
    - m_deltaTime: float
    - m_endTriggered: bool
    - m_hasEnded: bool
    - m_paused: bool
    - m_SceneStartTime: Uint64
    - m_actionMap: map<int, string>
    + Scene(gameEngine: GameEngine*)
    + virtual ~Scene()
    + virtual update() : void
    + virtual onEnd() : void
    + virtual sRender() : void
    + virtual sDoAction(action: Action&) : void
    + virtual sAudio() : void
    + virtual onSceneWindowResize() : void
    + registerAction(inputKey: int, actionName: string) : void
    + setPaused(paused: bool) : void
    + getActionMap() : map<int, string> const&
    + setStartTime(startTime: Uint64) : void
    + getStartTime() : Uint64 const&
  }

  class Action {
    - m_name: string
    - m_state: ActionState
    - m_pos: optional<Vec2>
    + Action(name: string, state: ActionState, pos: optional<Vec2>)
    + getName() : string const&
    + getState() : ActionState const&
    + getPos() : optional<Vec2> const&
  }

  enum ActionState {
    START
    END
  }
}

package "Managers" {
  package "Asset Management" {
    class FontManager {
      - m_fontPath: Path
      - m_fontSizeSm: int
      - m_fontSizeMd: int
      - m_fontSizeLg: int
      - m_fontLg: TTF_Font*
      - m_fontMd: TTF_Font*
      - m_fontSm: TTF_Font*
      + FontManager(fontPath: Path, fontSizeSm: int, fontSizeMd: int, fontSizeLg: int)
      + ~FontManager()
      + loadFonts(fontPath: Path) : void
      + getFontLg() : TTF_Font*
      + getFontMd() : TTF_Font*
      + getFontSm() : TTF_Font*
    }

    class TextureManager {
      - m_renderer: SDL_Renderer*
      - m_textures: unordered_map<string, SDL_Texture*>
      + TextureManager(renderer: SDL_Renderer*)
      + ~TextureManager()
      + registerTexture(name: string_view, path: filesystem::path) : void
      + hasTexture(name: string_view) : bool
      + getTexture(name: string_view) : SDL_Texture*
    }

    enum PriorityLevel {
      BACKGROUND
      STANDARD
      IMPORTANT
      CRITICAL
    }

    class QueuedSample <<internal>> {
      + sample: AudioSample
      + priority: PriorityLevel
      + timestamp: Uint64
    }

    class AudioSampleBuffer {
      - {static} SAMPLE_BUFFER_CAPACITY: size_t
      - {static} TRIM_LIMIT: size_t
      - {static} STALE_SAMPLE_MS: Uint64
      - {static} MIN_REPLAY_INTERVAL: Uint64
      - m_sampleBuffer: array<QueuedSample, SAMPLE_BUFFER_CAPACITY>
      - m_head: size_t
      - m_tail: size_t
      - m_size: size_t
      - m_lastPlayTimes: unordered_map<AudioSample, Uint64>
      - m_audioManager: AudioManager&
      - m_cooldowns: unordered_map<AudioSample, Uint64>
      - isBufferFull() : bool
      - pushSample(queuedSample: QueuedSample) : void
      - removeExpiredSamples(currentTime: Uint64) : void
      - removeAtOffset(offset: size_t) : void
      - evictLowerPrioritySample(incoming: PriorityLevel) : bool
      - trimLowPrioritySamples() : void
      + AudioSampleBuffer(audioManager: AudioManager&)
      + queueSample(sample: AudioSample, priority: PriorityLevel) : void
      + update() : void
    }
  }

  package "System Management" {
    enum AudioSample {
      NONE
      ITEM_ACQUIRED
      ENEMY_COLLISION
      SPEED_BOOST
      SLOWNESS_DEBUFF
      MENU_MOVE
      MENU_SELECT
      SHOOT
      BULLET_HIT_01
      BULLET_HIT_02
    }

    enum AudioTrack {
      NONE
      MAIN_MENU
      PLAY
    }

    class AudioManager {
      - m_audioTracks: unordered_map<AudioTrack, Mix_Music*>
      - m_audioSamples: unordered_map<AudioSample, Mix_Chunk*>
      - m_frequency: int
      - m_format: Uint16
      - m_channels: int
      - m_chunksize: int
      - m_currentAudioTrack: AudioTrack
      - m_lastAudioTrack: AudioTrack
      - m_lastAudioSample: AudioSample
      - m_audioTrackPaused: bool
      - m_tracksMuted: bool
      - m_samplesMuted: bool
      - m_savedTrackVolume: int
      - m_savedSampleVolumes: map<AudioSample, int>
      - loadTrack(track: AudioTrack, filepath: Path) : void
      - loadSample(sample: AudioSample, filepath: Path) : void
      - cleanup() : void
      + AudioManager()
      + AudioManager(frequency: int, format: Uint16, channels: int, chunksize: int)
      + ~AudioManager()
      + {static} MAX_SAMPLES_PER_FRAME: size_t
      + {static} DEFAULT_SAMPLE_VOLUME: int
      + {static} DEFAULT_TRACK_VOLUME: int
      + loadAllAudio() : void
      + playTrack(track: AudioTrack, loops: int) : void
      + playSample(sample: AudioSample, loops: int) : void
      + stopTrack() : void
      + pauseTrack() : void
      + resumeTrack() : void
      + {static} setTrackVolume(volume: int) : void
      + setSampleVolume(sampleTag: AudioSample, volume: int) : void
      + getSampleVolume(sampleTag: AudioSample) : int
      + {static} getTrackVolume() : int
      + muteTracks() : void
      + unmuteTracks() : void
      + muteSamples() : void
      + unmuteSamples() : void
      + muteAll() : void
      + unmuteAll() : void
      + toggleMuteAll() : void
      + toggleMuteTracks() : void
      + toggleMuteSamples() : void
      + getCurrentAudioTrack() : AudioTrack
      + getLastAudioTrack() : AudioTrack
      + getLastAudioSample() : AudioSample
      + {static} isTrackPlaying() : bool
      + {static} isTrackPaused() : bool
    }

    class VideoManager {
      - m_renderer: SDL_Renderer*
      - m_window: SDL_Window*
      - m_currentWindowSize: Vec2
      - m_config: ConfigAdapter&
      - {static} initializeVideoSystem() : void
      - setupRenderer() : void
      - createRenderer() : SDL_Renderer*
      - createWindow() : SDL_Window*
      + VideoManager(config: ConfigAdapter&)
      + ~VideoManager()
      + getWindowSize() : Vec2
      + updateWindowSize() : void
      + getRenderer() : SDL_Renderer*
      + getWindow() : SDL_Window*
      + cleanup() : void
      + {static} isWebCanvasEnabled() : bool
    }
  }
}

' Configuration subsystem
package "Configuration" {
  class ConfigDictionary {
    - m_configuration: unordered_map<string, ConfigValue>
    + set<T>(key: string, value: T) : void
    + get<T>(key: string) : optional<T>
    + contains(key: string) : bool
    + hasType<T>(key: string) : bool
    + clear() : void
  }

  interface IConfigProvider {
    + getKey(name: string) : ConfigValue
    + hasKey(name: string) : bool
  }

  class JsonConfigProvider {
    - m_configDict: ConfigDictionary
    - loadJsonIntoDict(json: json, prefix: string) : void
    + JsonConfigProvider(configPath: filesystem::path)
    + getKey(name: string) : ConfigValue
    + hasKey(name: string) : bool
  }

  class ConfigStore {
    - m_provider: unique_ptr<IConfigProvider>
    - m_dictionary: ConfigDictionary
    + ConfigStore(provider: unique_ptr<IConfigProvider>)
    + {static} fromJsonFile(jsonPath: filesystem::path) : unique_ptr<ConfigStore>
    + get(path: string) : ConfigValue
    + has(path: string) : bool
    + reload() : void
  }

  class ConfigAdapter {
    - m_store: ConfigStore&
    + {static} k(root: string, child: string) : string
    + {static} colorOr(def: SDL_Color, store: ConfigStore&, base: string) : SDL_Color
    + {static} floatOr(def: float, store: ConfigStore&, key: string) : float
    + {static} intOr(def: int, store: ConfigStore&, key: string) : int
    + {static} u64Or(def: Uint64, store: ConfigStore&, key: string) : Uint64
    + {static} strOr(def: string, store: ConfigStore&, key: string) : string
    + {static} vec2Or(def: Vec2, store: ConfigStore&, base: string) : Vec2
    + ConfigAdapter(store: ConfigStore&)
    + getGameConfig() : GameConfig
  }

  class GameConfig {
    + windowSize: Vec2
    + windowTitle: string
    + fontPath: filesystem::path
    + spawnInterval: Uint64
    + fontSizeSm: int
    + fontSizeMd: int
    + fontSizeLg: int
  }

  class EngineConfig {
    + windowSize: Vec2
    + windowTitle: string
    + fontPath: filesystem::path
    + fontSizeSm: int
    + fontSizeMd: int
    + fontSizeLg: int
  }
}

' Entity-Component System
package "ECS" {
  enum EntityTags {
    Player
    Wall
    SpeedBoost
    SlownessDebuff
    Enemy
    Bullet
    Item
    Default
  }

  class ComponentPool<T> {
    - m_sparse: vector<size_t>
    - m_denseIds: vector<size_t>
    - m_dense: vector<T>
    + contains(id: size_t) : bool
    + size() : size_t
    + empty() : bool
    + clear() : void
    + resizeSparse(size: size_t) : void
    + reserveDense(capacity: size_t) : void
    + emplace(id: size_t, args...) : T&
    + remove(id: size_t) : void
    + get(id: size_t) : T*
    + dense() : vector<T>&
    + denseIds() : vector<size_t>&
  }

  class ComponentRegistry {
    - m_transforms: ComponentPool<shared_ptr<CTransform>>
    - m_shapes: ComponentPool<shared_ptr<CShape>>
    - m_inputs: ComponentPool<shared_ptr<CInput>>
    - m_lifespans: ComponentPool<shared_ptr<CLifespan>>
    - m_effects: ComponentPool<shared_ptr<CEffects>>
    - m_bounceTrackers: ComponentPool<shared_ptr<CBounceTracker>>
    - m_sprites: ComponentPool<shared_ptr<CSprite>>
    + emplace<T>(id: size_t, component: shared_ptr<T>) : shared_ptr<T>
    + get<T>(id: size_t) : shared_ptr<T>
    + contains<T>(id: size_t) : bool
    + remove<T>(id: size_t) : void
    + dense<T>() : vector<shared_ptr<T>>&
    + denseIds<T>() : vector<size_t>&
    + removeAllForEntity(id: size_t) : void
  }

  class EntityManager {
    - m_entities: vector<shared_ptr<Entity>>
    - m_toAdd: vector<shared_ptr<Entity>>
    - m_entityMap: unordered_map<EntityTags, vector<shared_ptr<Entity>>>
    - m_totalEntities: size_t
    - m_components: shared_ptr<ComponentRegistry>
    + addEntity(tag: EntityTags) : shared_ptr<Entity>
    + getEntities() : vector<shared_ptr<Entity>>&
    + getEntities(tag: EntityTags) : vector<shared_ptr<Entity>>&
    + components() : ComponentRegistry&
    + components() : ComponentRegistry const&
    + update() : void
  }

  class Entity {
    - m_active: bool
    - m_id: size_t
    - m_tag: EntityTags
    - m_registry: weak_ptr<ComponentRegistry>
    + isActive() : bool
    + tag() : EntityTags
    + id() : size_t
    + destroy() : void
    + getCenterPos() : Vec2
    + getComponent<T>() : shared_ptr<T>
    + setComponent<T>(shared_ptr<T>) : void
    + removeComponent<T>() : void
    + hasComponent<T>() : bool
  }

  package "Components" {
    class CTransform {
      + topLeftCornerPos: Vec2
      + velocity: Vec2
      + CTransform(position: Vec2, velocity: Vec2)
      + CTransform()
    }

    class CShape {
      - renderer: SDL_Renderer*
      + rect: SDL_Rect
      + color: SDL_Color
      + CShape(renderer: SDL_Renderer*, height: float, width: float, color: SDL_Color)
    }

    class CInput {
      + forward: bool
      + backward: bool
      + left: bool
      + right: bool
      + CInput()
    }

    class CLifespan {
      + birthTime: Uint64
      + lifespan: Uint64
      + CLifespan()
      + CLifespan(lifespan: Uint64)
    }

    enum EffectTypes {
      Speed
      Slowness
    }

    class Effect {
      + startTime: Uint64
      + duration: Uint64
      + type: EffectTypes
    }

    class CEffects {
      - effects: vector<Effect>
      + CEffects()
      + addEffect(effect: Effect) : void
      + getEffects() : vector<Effect> const&
      + removeEffect(type: EffectTypes) : void
      + hasEffect(type: EffectTypes) : bool
      + clearEffects() : void
    }

    class CBounceTracker {
      - m_bounces: int
      + CBounceTracker()
      + addBounce() : void
      + getBounces() : int
    }

    class CSprite {
      - m_texture: SDL_Texture*
      + CSprite(texture: SDL_Texture*)
      + getTexture() : SDL_Texture*
    }
  }
}

' Relationships
GameEngine --> FontManager : owns
GameEngine --> TextureManager : owns
GameEngine --> AudioManager : owns
GameEngine --> AudioSampleBuffer : owns
GameEngine --> VideoManager : owns
GameEngine --> ConfigStore : owns
GameEngine --> ConfigAdapter : owns
GameEngine --> Scene : manages

Scene --> GameEngine : uses
Scene --> Action : uses

AudioSampleBuffer *-- QueuedSample : buffer
AudioSampleBuffer --> AudioManager : uses

ConfigAdapter --> ConfigStore : wraps
ConfigAdapter --> GameConfig : returns
ConfigStore --> IConfigProvider : owns
ConfigStore --> ConfigDictionary : stores
JsonConfigProvider ..|> IConfigProvider
JsonConfigProvider --> ConfigDictionary : fills

EntityManager --> Entity : creates/manages
EntityManager --> ComponentRegistry : owns
Entity --> EntityTags : tags
Entity --> ComponentRegistry : uses
ComponentRegistry *-- ComponentPool : stores
CEffects --> Effect : stores
Effect --> EffectTypes : type

note left of GameEngine
  Initializes managers and hosts the main loop
  Provides access to configuration and scene lifecycle
end note

note right of EntityManager
  Tag-based lookups with a shared ComponentRegistry
end note

@enduml
